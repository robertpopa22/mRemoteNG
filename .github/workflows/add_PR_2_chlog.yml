name: Update Changelog After Renovate PR Merge

on:
  push:
    branches:
      - v1.78.2-dev   # ‚Üê replace with your actual default branch

  workflow_dispatch:
    inputs:
      dryRun:
        description: 'Run without committing changes'
        required: false
        default: 'true'

jobs:
  update-changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Parse last commit for Renovate info
        id: extract
        shell: pwsh
        run: |
          # Determine dryRun setting
          $dryRun = '${{ github.event.inputs.dryRun }}'
          if (-not $dryRun) { $dryRun = 'false' }
          Write-Host "üîç dryRun = $dryRun"

          # Get the full commit message (subject + body)
          $fullMessage = git log -1 --pretty=%B
          Write-Host "üìù Full commit message:"
          Write-Host $fullMessage

          # Grab the line that contains the dependency update
          $prLine = $fullMessage |
            Select-String -Pattern 'chore\(deps\): update dependency'
          if (-not $prLine) {
            throw "‚ùå No 'chore(deps): update dependency' line found"
          }

          # Clean it up
          $line = $prLine.Line.Trim()

          # Extract PR number at the end (#1234)
          if ($line -match '#(\d+)$') {
            $pr = $matches[1]
          } else {
            throw "‚ùå No PR number found in: $line"
          }

          # Extract dependency name and version
          if ($line -match 'chore\(deps\): update dependency ([\w\.\-]+) to ([\d\.]+)') {
            $dep = $matches[1]
            $ver = $matches[2]
          } else {
            throw "‚ùå Could not parse dependency name/version from: $line"
          }

          Write-Host "‚úÖ Parsed PR#$pr ‚Üí $dep v$ver"

          # Export for later steps
          echo "pr=$pr"         >> $env:GITHUB_OUTPUT
          echo "depName=$dep"   >> $env:GITHUB_OUTPUT
          echo "depVersion=$ver">> $env:GITHUB_OUTPUT
          echo "dryRun=$dryRun" >> $env:GITHUB_OUTPUT

      - name: Update CHANGELOG.md
        shell: pwsh
        run: |
          $changelog = "$env:GITHUB_WORKSPACE/CHANGELOG.md"
          if (-not (Test-Path $changelog)) {
            throw "‚ùå CHANGELOG.md not found"
          }

          $lines      = Get-Content $changelog
          $pr         = '${{ steps.extract.outputs.pr }}'
          $dep        = '${{ steps.extract.outputs.depName }}'
          $ver        = '${{ steps.extract.outputs.depVersion }}'
          $entry      = "- #$pr: update $dep to $ver"

          # Find the latest version header: ## [x.y.z]
          $vIndex = $lines.FindIndex({ $_ -match '^## \[\d+\.\d+\.\d+\]' })
          if ($vIndex -lt 0) {
            throw "‚ùå No '## [x.y.z]' header found"
          }

          # Locate (or insert) the '### Dependency update' section
          $depIndex = -1
          for ($i = $vIndex+1; $i -lt $lines.Count; $i++) {
            if ($lines[$i] -match '^### Dependency update') {
              $depIndex = $i
              break
            }
            if ($lines[$i] -match '^## ') { break }
          }

          if ($depIndex -eq -1) {
            $lines.Insert($vIndex+1, '### Dependency update')
            $depIndex = $vIndex + 1
          }

          # Insert our entry
          $lines.Insert($depIndex+1, $entry)
          Set-Content -Path $changelog -Value $lines

          Write-Host "‚úÖ Inserted into CHANGELOG.md:"
          Write-Host "   $entry"

      - name: Commit & push (if not dry-run)
        if: steps.extract.outputs.dryRun != 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add CHANGELOG.md
          git commit -m "docs: update changelog for #${{ steps.extract.outputs.pr }}"
          git push
