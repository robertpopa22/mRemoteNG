name: Update Changelog After Renovate PR Merge

on:
  push:
    branches:
      - v1.78.2-dev   # ‚Üê replace with your default branch

  workflow_dispatch:
    inputs:
      dryRun:
        description: 'Run without committing changes'
        required: false
        default: 'true'

jobs:
  update-changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check for Renovate dependency update
        id: check-renovate
        shell: bash
        run: |
          # Always true for manual runs
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "isRenovate=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Inspect the last commit message
          msg=$(git log -1 --pretty=%B)
          if echo "$msg" | grep -q 'chore(deps): update dependency'; then
            echo "isRenovate=true" >> $GITHUB_OUTPUT
          else
            echo "isRenovate=false" >> $GITHUB_OUTPUT
          fi

      - name: Skip if not a Renovate PR
        if: steps.check-renovate.outputs.isRenovate == 'false'
        run: |
          echo "‚ÑπÔ∏è No Renovate dependency update found in the last commit. Skipping changelog update."
          
      - name: Parse Renovate PR info
        if: steps.check-renovate.outputs.isRenovate == 'true'
        id: extract
        shell: pwsh
        run: |
          # Determine dryRun
          $dryRun = '${{ github.event.inputs.dryRun }}'
          if (-not $dryRun) { $dryRun = 'false' }
          Write-Host "üîç dryRun = $dryRun"

          # Grab full commit message
          $fullMsg = git log -1 --pretty=%B

          # Extract PR number (#1234)
          if ($fullMsg -match '#(\d+)\s*$') {
            $prNumber = $matches[1]
          } else {
            throw "‚ùå No PR number found in commit message"
          }

          # Extract dependency name & version
          if ($fullMsg -match 'chore\(deps\): update dependency ([\w\.\-]+) to ([\d\.]+)') {
            $depName    = $matches[1]
            $depVersion = $matches[2]
          } else {
            throw "‚ùå Could not parse dependency info"
          }

          echo "pr=$prNumber"      >> $env:GITHUB_OUTPUT
          echo "depName=$depName"   >> $env:GITHUB_OUTPUT
          echo "depVersion=$depVersion" >> $env:GITHUB_OUTPUT
          echo "dryRun=$dryRun"     >> $env:GITHUB_OUTPUT

      - name: Update CHANGELOG.md
        if: steps.check-renovate.outputs.isRenovate == 'true'
        shell: pwsh
        run: |
          $path = "$env:GITHUB_WORKSPACE/CHANGELOG.md"
          if (-not (Test-Path $path)) { throw "‚ùå CHANGELOG.md not found" }

          $lines      = Get-Content $path
          $pr         = '${{ steps.extract.outputs.pr }}'
          $dep        = '${{ steps.extract.outputs.depName }}'
          $ver        = '${{ steps.extract.outputs.depVersion }}'
          $entry      = "- #$pr: update $dep to $ver"

          # Locate latest version header: ## [x.y.z]
          $vIndex = $lines.FindIndex({ $_ -match '^## \[\d+\.\d+\.\d+\]' })
          if ($vIndex -lt 0) { throw "‚ùå No version header found" }

          # Find or insert '### Dependency update'
          $depIndex = -1
          for ($i = $vIndex+1; $i -lt $lines.Count; $i++) {
            if ($lines[$i] -match '^### Dependency update') {
              $depIndex = $i; break
            }
            if ($lines[$i] -match '^## ') { break }
          }
          if ($depIndex -eq -1) {
            $lines.Insert($vIndex+1, '### Dependency update')
            $depIndex = $vIndex+1
          }

          # Insert the new line
          $lines.Insert($depIndex+1, $entry)
          Set-Content -Path $path -Value $lines

          Write-Host "‚úÖ Changelog entry inserted:"
          Write-Host "   $entry"

      - name: Commit & push
        if: steps.check-renovate.outputs.isRenovate == 'true' && steps.extract.outputs.dryRun != 'true'
        run: |
          git config user.name  "github-actions"
          git config user.email "github-actions@github.com"
          git add CHANGELOG.md
          git commit -m "docs: update changelog for #${{ steps.extract.outputs.pr }}"
          git push
