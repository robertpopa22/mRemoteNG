name: Build_and_Release_mR-NB
on:
  push:
    branches:
      - v1.78.2-dev
      - release/1.80
    tags:
      - 'v*'

  workflow_dispatch:
    inputs:
      release_flag:
        description: 'Run NB release'
        required: false
        default: 'true'

permissions:
  contents: write
  actions: read
  id-token: write

jobs:
  # ============================================================
  # Job 1: Build all platform variants
  # ============================================================
  build:
    name: Build ${{ matrix.arch }}${{ matrix.suffix }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Framework-dependent builds (requires .NET runtime on target)
          - runner: windows-2025-vs2026
            platform: x86
            arch: x86
            selfcontained: false
            suffix: ""
          - runner: windows-2025-vs2026
            platform: x64
            arch: x64
            selfcontained: false
            suffix: ""
          - runner: windows-11-arm
            platform: ARM64
            arch: arm64
            selfcontained: false
            suffix: ""
          # Self-contained builds (embeds .NET runtime, no install required)
          - runner: windows-2025-vs2026
            platform: x86
            arch: x86
            selfcontained: true
            suffix: "-selfcontained"
          - runner: windows-2025-vs2026
            platform: x64
            arch: x64
            selfcontained: true
            suffix: "-selfcontained"
          - runner: windows-11-arm
            platform: ARM64
            arch: arm64
            selfcontained: true
            suffix: "-selfcontained"
    runs-on: ${{ matrix.runner }}
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && (
        startsWith(github.ref, 'refs/tags/v') ||
        github.ref == 'refs/heads/release/1.80' ||
        contains(github.event.head_commit.message, 'NB release')
      ))

    steps:
      - name: (01) Checkout Repository
        uses: actions/checkout@v6

      - name: (02) Setup dotnet
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: (03) Setup MSBuild
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: ${{ matrix.platform == 'ARM64' && '17.14.12' || '[18.0,19.0)' }}

      - name: (04) Generate AssemblyInfo.cs from T4 template values
        shell: pwsh
        run: |
          $major = 1; $minor = 80; $revision = 0; $channel = "Release"
          $base = [datetime]"2019-09-02"
          $build = [int](([datetime]::UtcNow - $base).TotalMinutes / 1000)
          $platform = "${{ matrix.platform }}"
          $year = [datetime]::UtcNow.Year
          $content = @"
          //Generated for platform: $platform
          using System.Reflection;
          using System.Resources;
          //Build nr: $build
          [assembly: AssemblyTitle("mRemoteNG")]
          [assembly: AssemblyDescription("Multi-Remote Next Generation Connection Manager")]
          [assembly: AssemblyConfiguration("$platform")]
          [assembly: AssemblyCompany("Profi-KOM Ltd.")]
          [assembly: AssemblyProduct("mRemoteNG Connection Manager")]
          [assembly: AssemblyCopyright("(c) $year mRemoteNG")]
          [assembly: AssemblyTrademark("Profi-KOM LTd.")]
          [assembly: AssemblyCulture("")]
          [assembly: AssemblyVersion("$major.$minor.$revision.$build")]
          [assembly: AssemblyFileVersion("$major.$minor.$revision.$build")]
          [assembly: NeutralResourcesLanguageAttribute("en-US")]
          [assembly: AssemblyInformationalVersion("$major.$minor.$revision ($channel $build) $platform")]
          "@
          $outPath = "$env:GITHUB_WORKSPACE\mRemoteNG\Properties\AssemblyInfo.cs"
          Set-Content -Path $outPath -Value $content -Encoding UTF8
          Write-Host "Generated AssemblyInfo.cs: v$major.$minor.$revision.$build ($channel) $platform"
          echo "version=$major.$minor.$revision" >> $env:GITHUB_OUTPUT
          echo "build=$build" >> $env:GITHUB_OUTPUT
        id: version_info

      - name: (05) Cache NuGet Packages
        uses: actions/cache@v5
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-${{ matrix.arch }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-nuget-

      - name: (06) Restore NuGet Packages
        shell: pwsh
        run: |
          if ('${{ matrix.selfcontained }}' -eq 'true') {
            dotnet restore --runtime win-${{ matrix.arch }} /p:PublishReadyToRun=true
          } else {
            dotnet restore
          }

      - name: (07) Build Release
        shell: pwsh
        run: |
          $msbuildArgs = @(
            "`"$Env:GITHUB_WORKSPACE\mRemoteNG.sln`""
            "-p:Configuration=Release"
            "-p:Platform=${{ matrix.platform }}"
            "-p:CrashReportToken=${{ secrets.CRASH_REPORT_TOKEN }}"
            "/verbosity:minimal"
          )
          if ('${{ matrix.selfcontained }}' -eq 'true') {
            $msbuildArgs += "-p:SelfContained=true"
            $msbuildArgs += "-p:RuntimeIdentifier=win-${{ matrix.arch }}"
            $msbuildArgs += "-p:PublishDir=bin\${{ matrix.platform }}\Release\publish\"
            $msbuildArgs += "-t:Publish"
          }
          $cmd = "msbuild " + ($msbuildArgs -join " ")
          Write-Host "Running: $cmd"
          Invoke-Expression $cmd

      - name: (08) Release Information
        id: version
        shell: pwsh
        run: |
          $assemblyInfoPath = "${{ github.workspace }}\mRemoteNG\Properties\AssemblyInfo.cs"
          $line = Get-Content $assemblyInfoPath | Where-Object { $_ -match 'AssemblyVersion\("(.+?)"\)' }
          if ($line -match 'AssemblyVersion\("(?<ver>\d+\.\d+\.\d+)\.(?<build>\d+)"\)') {
            $version = $matches['ver']
            $build = $matches['build']
          } else {
            throw "Could not extract version and build number"
          }
          $date = Get-Date -Format "yyyyMMdd"
          $suffix = "${{ matrix.suffix }}"
          $zipName = "mRemoteNG-$date-v$version-NB-$build-${{ matrix.arch }}$suffix.zip"
          echo "zipname=$zipName" >> $env:GITHUB_OUTPUT
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "build=$build" >> $env:GITHUB_OUTPUT

      - name: (09) Create unsigned ZIP
        shell: pwsh
        run: |
          if ('${{ matrix.selfcontained }}' -eq 'true') {
            $sourceDir = "$Env:GITHUB_WORKSPACE\mRemoteNG\bin\${{ matrix.platform }}\Release\publish"
          } else {
            $sourceDir = "$Env:GITHUB_WORKSPACE\mRemoteNG\bin\${{ matrix.platform }}\Release"
          }
          # Exclude build intermediates from ZIP
          $items = Get-ChildItem -Path $sourceDir | Where-Object { $_.Name -notin @('ref','publish','win-x64','win-x86','win-arm64','win-x64-sc') }
          Compress-Archive -Path $items.FullName -DestinationPath "$Env:GITHUB_WORKSPACE\${{ steps.version.outputs.zipname }}" -Force
          Write-Host "Created unsigned ZIP: ${{ steps.version.outputs.zipname }}"

      # --------------------------------------------------------
      # Upload build artifact (unsigned)
      # --------------------------------------------------------
      - name: (10a) Upload build artifact
        id: upload-build
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.arch }}${{ matrix.suffix }}
          path: ${{ steps.version.outputs.zipname }}
          retention-days: 5

      # --------------------------------------------------------
      # CODE SIGNING â€” SignPath Foundation (OPTIONAL)
      # Skipped when SIGNPATH_API_TOKEN secret is not configured.
      # --------------------------------------------------------
      - name: (10b) Submit signing request to SignPath
        id: sign
        if: ${{ secrets.SIGNPATH_API_TOKEN != '' }}
        continue-on-error: true
        uses: signpath/github-action-submit-signing-request@v1
        with:
          api-token: '${{ secrets.SIGNPATH_API_TOKEN }}'
          organization-id: '${{ secrets.SIGNPATH_ORGANIZATION_ID }}'
          project-slug: 'mRemoteNG'
          signing-policy-slug: 'release-signing'
          github-artifact-id: '${{ steps.upload-build.outputs.artifact-id }}'
          wait-for-completion: true
          output-artifact-directory: '${{ github.workspace }}/signed'
          wait-for-completion-timeout-in-seconds: 600

      - name: (10c) Upload signed artifact (if signing succeeded)
        if: steps.sign.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: signed-${{ matrix.arch }}${{ matrix.suffix }}
          path: ${{ github.workspace }}/signed/*
          retention-days: 5

  # ============================================================
  # Job 2: Aggregate signed artifacts into a single release
  # ============================================================
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: (01) Checkout Repository
        uses: actions/checkout@v6

      - name: (02) Compute release metadata
        id: meta
        shell: pwsh
        run: |
          $major = 1; $minor = 80; $revision = 0
          $base = [datetime]"2019-09-02"
          $build = [int](([datetime]::UtcNow - $base).TotalMinutes / 1000)
          $date = Get-Date -Format "yyyyMMdd"
          $tag = "$date-v$major.$minor.$revision-NB-($build)"
          $message = git log -1 --pretty=%B
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "version=$major.$minor.$revision" >> $env:GITHUB_OUTPUT
          echo "build=$build" >> $env:GITHUB_OUTPUT
          echo "message=$message" >> $env:GITHUB_OUTPUT

      - name: (03) Extract Changelog Section
        id: changelog
        shell: pwsh
        run: |
          $changelogPath = "$env:GITHUB_WORKSPACE/CHANGELOG.md"
          $lines = Get-Content $changelogPath

          $startIndex = -1
          for ($i = 0; $i -lt $lines.Count; $i++) {
            if ($lines[$i] -match '^## \[') {
              $startIndex = $i
              break
            }
          }

          if ($startIndex -eq -1) {
            throw "No version header found in CHANGELOG.md"
          }

          $section = @()
          for ($i = $startIndex + 1; $i -lt $lines.Count; $i++) {
            if ($lines[$i] -match '^## ') {
              break
            }
            $section += $lines[$i]
          }

          $joined = $section -join "`n"
          echo "log<<EOF" >> $env:GITHUB_OUTPUT
          echo $joined >> $env:GITHUB_OUTPUT
          echo "EOF" >> $env:GITHUB_OUTPUT

      - name: (04) Download signed artifacts (if available)
        id: download-signed
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          pattern: signed-*
          path: release-assets
          merge-multiple: true

      - name: (05) Download unsigned artifacts (fallback)
        if: steps.download-signed.outcome == 'failure' || hashFiles('release-assets/**') == ''
        uses: actions/download-artifact@v4
        with:
          pattern: build-*
          path: release-assets
          merge-multiple: true

      - name: (06) List release assets
        shell: bash
        run: |
          echo "Release assets:"
          ls -lh release-assets/

      - name: (07) Create release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: "mRemoteNG ${{ steps.meta.outputs.version }} NB ${{ steps.meta.outputs.build }}"
          files: release-assets/*
          body: |
            Changes in this Release:
            ${{ steps.changelog.outputs.log }}

            Last Commit Message:
            ${{ steps.meta.outputs.message }}
          draft: false
          prerelease: true
